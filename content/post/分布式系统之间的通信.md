---
title: "分布式系统之间常用的通信方式"
date: "2017-04-17"
categories: ["分布式系统"]
tags: ["通信"]
---



# 分层协议

## 低层协议

所谓低层协议指的是OSI模型中三个最低层的协议，分别是物理层、数据链路层、IP层, 这三层共同实现了计算机网络的基本功能。

## 传输协议

传输协议将低层的协议进行封装，使得能以程序接口的形式暴露给开发人员进行开发应用程序。

传输协议分为两种：可靠传输和不可靠传输，也就是面向连接的TCP协议和不连接的UDP协议。

## 高层协议

高层协议也被称为应用层协议，例如http、ftp。 还有其他一些协议，这些协议并不能算应用层协议，一般称为中间件协议。

## 中间件协议

首先中间件是一种程序，中间件程序位于应用层逻辑中，但其中包含多种应用协议，中间件协议可以归属为传输层，因为它最终还是为上层应用服务的。

# 通信类型

## 持久通信

持久通信传输的消息由通信中间件存储，直到该消息传送给接收方为止。

## 瞬时通信

瞬时通信只有在发送和接收程序在运行时才会存储消息，如果某一方宕机消息会被丢弃。通常，所有传输层通信服务都只提供瞬时通信

## 异步通信

异步通信最显著的特点是：发送方在提交传输的消息后立即放下进行，这就需要一个中间件程序在消息发送后立即将消息存储起来。

## 不连续通信/流通信

不连续通信: 各方以消息组成一个完整的信息单元

流通信: 一个接一个的发送多个消息，消息顺序是相互有关联的。

# RPC协议

大多数分布式系统是基于进程间的消息显示交换的，既然显示交换消息，就避免不了诸如 `sebd`, `receive` 的调用，但通信的隐匿性对于分布式系统也是很重要的，于是就提出了一个协议，这个协议
称为远程过程调用(remote procedure call, RPC).

RPC协议认为程序可以调用其他机器上的进程，这个概念简单而又复杂。

基本思想是，当机器A上的进程调用机器B上的进程时，A可以将参数传递给B，B接收到调用会接收参数并将结果回传给A。 至于信息交换的过程对于程序员来说是隐藏的。

虽然RPC协议听起来简单，但实际上还存在很多具体的问题:

- 进程分布在不同的机器上，具有不稳定因素
- 需要进行参数和结果的传递，传递的消息可能是复杂的
- 双方机器可能发生宕机，任何一方的故障都会导致另一方调用失败

## 本地过程调用

在看RPC之前，先看一下调用本地的过程， 假如有如下一个系统调用

```
read_num = read(fd, buf, nbytes)
```

`read` 是一个系统调用，用来读取文件描述符，其中`fd`是文件描述符(unix对I/O的抽象)，`buf` 是一个字符数组，用于存储读入的数据， `nbytes` 则是需要读取多少字节的数据.

当调用`read` 后，编译器首先将调用信息压入栈中，当read执行完后结果并交回调用方。

可以看到，在调用`read`时，程序员不需要知道 `read` 需要怎么执行，整个过程是隐蔽的，全部交由操作系统来执行。

## 远程过程调用

RPC背后的思想是，尽可能的让远程过程调用和本地过程调用相同。

假如 `read` 是一个远程过程调用时，在调用read时，客户端将阻塞，read调用的参数将通过网络传递给被调用方，调用方收到调用后开始执行，结果再通过网络回传给调用方，当调用方收到返回结果时会继续往下运行。

整个网络传递过程一般由RPC程序实现，对于程序员来说是他并不知道整个调用过程是本地执行的，还是远程执行的，调用方所涉及的只是通过和本地调用一样的方式来访问远程服务。

一般来说，远程过程调用包含如下步骤:

1. 调用方以正常的方式调用rpc程序
2. rpc生成一个消息，通过操作系统将消息发送给被调用方所在的机器
3. 被调用方rpc程序收到消息，提取出消息，调用相应的程序。
4. 被调用方调用完毕后，rpc将结果打包成一个消息，然后通过操作系统返回给调用方。
5. 调用方rpc程序收到结果消息后，提取出消息，返回给调用者。

## 异步RPC

同步的RPC与常规过程调用一样，在调用时，客户端将阻塞，直到服务端返回结果。

异步RPC则是客户端调用后，只要收到服务端确认收到信息后就继续往下执行，不阻塞进程。

# 面向消息的通信

## 面向消息的瞬时通信

## 消息队列

消息队列是一种面向消息的持久通信或者成为面向消息的中间件，为持久异步通信提供多种方式。 本质是提供消息的中介存储能力，这样就不需要消息发送方和接收方在消息传输过程中都要保持激活状态。

## 消息队列模型

### 点对点

**点对点模式下包括三个角色**：

- 消息队列
- 发送者 (生产者)
- 接收者（消费者）

**点对点模型执行过程**:

消息发送者生产消息发送到queue中，然后消息接收者从queue中取出并且消费消息。消息被消费以后，queue中不再有存储，所以消息接收者不可能消费到已经被消费的消息。

**点对点模式特点**：

1. 每个消息只有一个接收者（Consumer）(即一旦被消费，消息就不再在消息队列中)；
2. 发送者和接收者间没有依赖性，发送者发送消息之后，不管有没有接收者在运行，都不会影响到发送者下次发送消息；
3. 接收者在成功接收消息之后需向队列应答成功，以便消息队列删除当前接收的消息；

### 发布与订阅

**发布/订阅模式下包括三个角色**：

1. 主题（Topic）
2. 发布者(Publisher)
3. 订阅者(Subscriber)

**发布订阅模型过程**:

发布者将消息发送到Topic,系统将这些消息传递给多个订阅者。

**发布/订阅模式特点**：

1. 每个消息可以有多个订阅者；
2. 发布者和订阅者之间有时间上的依赖性。针对某个主题（Topic）的订阅者，它必须创建一个订阅者之后，才能消费发布者的消息。
3. 为了消费消息，订阅者需要提前订阅该角色主题，并保持在线运行；

