---
title: "IP协议中的ARP是啥"
date: "2018-02-19"
categories: ["计算机网络"]
tags: ["ip", "arp"]

---

只要知道了IP地址，就可以像目标IP发送数据，但在底层数据链路通信中，使用的是mac地址，因此主机与目标IP进行通信时，需要了解对方的mac地址。

为了解决这个问题，产生了ARP（Address Resolution Protocol）。ARP将IP地址为线索，用来定位下一个接收数据包的网络设备对应的MAC地址。如果目标主机不在同一个链路上时，可以通过ARP查找下一跳路由器的MAC地址。

ARP只适用于IPv4。

# ARP工作原理
既然可以通过ARP来确定目标的mac地址，那么ARP是怎么工作的呢？
简单地说，ARP是借助ARP请求与ARP响应两种类型的包确定MAC地址的。

![ARP工作机制](https://upload-images.jianshu.io/upload_images/14252596-65ed5c513f803830.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

如图，主机A（172.20.1.2）向同一链路上的主机B发送地址，但它们互相不知道自己的IP地址，主机A为了获取主机B的地址，会借助于ARP，具体步骤为：
1. 主机A（172.20.1.2）发送一个ARP请求包，会包含主机B（172.20.1.2）的IP地址，发送方式为**广播（广播的包可以被同一个链路上所有的主机或路由器接收，因此ARP的请求包会被这同一个链路上所有的主机和路由器进行解析）**
2. 主机B收到了ARP请求包，会检查ARP请求包中的目标IP地址与自己的IP地址是否一致，如果一致，那么这个节点就将自己的MAC地址塞入ARP响应包返回给主机A

通过以上方式，借助ARP实现了链路内的IP通信。

##　不同网段的ARP
上面介绍了同一链路内两个主机之间通过ARP协议获取对方mac地址，如果处理不同链路内又该如何做呢？

在探讨这个问题之前，需要先了解一个规则：**不同网段主机之间的通信需要网关中转**

当处于不同网段的主机A和B之间使用ARP时，会经历如下步骤：
1. 主机A发送广播ARP数据包，由于网关和主机A处于同一网段，可以收到数据包
2. 网关收到主机A的数据包后，拿到目标主机B的IP地址
3. 网关查询自己的路由表发现主机B与自己另外一个接口在相同网段，于是广播ARP数据包得到主机B的IP地址
4. 通过同样的流程，主机B的IP地址会最终返回给主机A

# ARP缓存
每次发送一个IP数据报就要发送一个ARP请求势必会造成不必要的网络流量，因此，通常的做法是把获取到的MAC地址**缓存**。

系统会把mac地址和IP做一层映射表记录起来（Linux/Unix可以通过 **arp -a** 查看该映射表）。下一次再向这个IP地址发送数据报时不需再重新发送ARP请求，而是直接使用这个缓存表当中的MAC地址进行数据报的发送。

需要注意的是：每执行一次ARP，其对应的缓存内容都会被清除。

# RARP
RARP（Reverse Address Resolution Protocol）是将ARP反过来，从MAC地址定位IP地址的一种协议。

为什么需要RARP呢？

我们的个人电脑可以手动设置IP地址，也可以通过DHCP自动分配获取IP地址。然而，对于使用嵌入式设备时，会遇到没有任何输入接口或无法通过DHCP动态获取IP地址的情况。

因此，可以架设一台RARP服务器，从而在这个服务器上注册设备的MAC地址及其IP地址。通过查询RARP服务器可以获得IP地址。

![RARP](https://upload-images.jianshu.io/upload_images/14252596-71e2516b19031734.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# 代理ARP
通常ARP包会被路由器隔离，但是采用代理ARP（Proxy ARP）的路由器可以将ARP请求转发给邻近的网段。由此，两个以上网段的节点之间可以像在同一个网段中一样进行通信。

在目前的TCP/IP网络当中，一般情况下用路由器连接多个网络时，会在每个网段上定义各自的子网，从而进行路由控制。然而，对于那些不支持设定子网掩码的老设备来说，不使用代理ARP，有时就无法更好地使用网络。