---
title: Lecture 04 Fault-Tolerant Virtual Machines Paper
author: "Soul Mate"
categories: ["MIT-6.824"]
date: 2019-04-30
url: "/distributed-systems/mit-6.824/lec04-fault-tolerant-virtual-machines-paper-transalte.html"
---
# 容错虚拟机实用系统的设计

## 摘要

我们实现了一个为商业企业级系统提供容错的虚拟机, 该系统基于通过另一台备份服务器复制主虚拟机(VM) 执行。 我们在 VMwarevSphere 4.0 设计了一个完整易用的系统, 该系统运行在商用服务器上, 该系统通常会将实际的应用程序性能降低10%。此外，对于多个实际应用程序，保持主虚拟机和副虚拟在执行锁步所需的数据带宽小于 20Mbit/s，这允许在更长距离内实现容错。一个易用的商业系统，在故障后自动恢复冗余系统，除了复制VM的执行外，还需要许多其他组件。我们设计并实现了这些额外的组件，并解决了在支持企业级虚拟机应用程序运行时遇到的许多实际问题。在本文中，我们描述了我们的基本设计，讨论了可选的设计方案和一些实现细节，并为micro-benchmarks 和 real applications这两者提供了性能测试结果。

## 1.引言
实现服务器容错的一种常见方法是主/备方法[1], 在这种方法中，如果主服务器出现故障，备份服务器总是可以有效接管。备份服务器的状态始终要与主服务器保持一致，因此当主服务器出现故障时，备份服务器可以立即接管，这样就可以将故障隐藏到外部客户端，而不会丢失任何数据。在备用服务器上实现状态复制的一种方法是把主服务器包括CPU，内存，I/O设备的更改连续的发送给备用服务器。然而，发送这种状态所需的带宽，特别是内存的变化，可能非常大。

一种与之不同的方法可以减少服务器复制时带宽的使用，有时被称为状态机方法[13]. 其思想是服务器是确定性状态机模型，启动时它们有相同的初始状态并确保它们以相同的顺序接收相同的请求，从而保持同步。由于大多数服务器或者服务有一些操作是不确定的，因此需要额外协调它们来确保主服务器和备用服务器保持同步。然而，保持主服务器和备用服务器同步所需的额外信息数量远小于主服务器中正在更改的状态数量（主要是内存更新）。

通过实现协调以保证物理服务器确定性的执行是较难的[14]，特别是随着处理频率的增加。相比之下，在管理程序上运行的虚拟机是实现状态机方法很好的平台。VM可以被视为定义明确的状态机，其操作是被虚拟化的操作（包括所有设备）。与物理服务器一样，VM有一些非确定操作（例如 读时钟或者中断事件传递），因此额外的信息必须发送到备份服务器以确保它们保持同步。由于监控程序对虚拟机具有完全控制权，包含传递的所有输入，因此虚拟机能够捕捉到关于主VM上非确定性操作的所有必要信息，并在备份虚拟机上正确的重放这些操作。

因此，状态机方法可用在商业硬件上的虚拟机，而无需对硬件进行任何修改，从而允许对最新微处理器立即实现容错。此外，状态机方法所需的低带宽也能允许主/被在物理上分离的更大。例如，复制的虚拟机可以在不同区域的物理机上运行，这比在同一区域运行的虚拟机提供了更高的可靠性。
我们已经在VMware vSphere 4.0平台使用 primark/backup 方法实现了VM容错，它以高效的方式运行在完全虚拟化的 x86虚拟机上。由于VMware vSphere实现了一个完整的x86虚拟机，因此我们能够为任何x86操作系统和应用程序提供容错能力。允许我们记录主服务器执行并确保备用服务器以相同的方式执行的技术称为确定性重放[15]。VMware vSphere的容错是基于这一理论，但添加了必要的额外协议和功能，以构建一个完整的容错系统。除了提供硬件容错外，我们的系统还通过本地集群中任何可用服务器上启动新的虚拟机，在发生故障后自动恢复冗余。此时，确定性重放和VMware FT的生产版本仅支持单处理器的VM。
记录和重放多处理器VM执行的工作还是进行中，但是存在严重的性能问题，因为几乎每个处理器对共享内存的访问都可能是一个非确定性的操作。

Bressoud和Schneider[3]描述了HP PA-RISC平台容错虚拟机的原型实现。我们的方法与之类似，但出于性能的原因，我们做了一些基本的改动，并研究了一些备选设计方案。此外，我们还必须设计和实现系统中的许多额外组件，以构建一个完整的的系统使运行企业应用程序的客户能够高效的使用。与讨论的其他实际系统类似，我们只尝试处理 fail-stop 故障，即在故障服务器导致外部可见动作错误之前可以检查到服务器故障。

![图 1: 基本的 FT 架构](/images/distributed-systems/4858d6a8ly1ffrt85wk4wj20a50bmdh1.jpg)

论文的其余部分组织如下。首先，我们描述了我们的基本设计，并详细介绍了我们的基本协议，这些协议确保在主虚拟机发生故障后如果备用虚拟机接管，则不会有数据丢失。然后，我们详细描述了构建一个健壮，完整和自动化系统所必须解决的实际问题。我们还描述了实现虚拟机容错时出现的几种选择，并讨论了选择中时的权衡。接着，我们给出一些基准和一些企业实际应用程序的实现的性能结果。最后，我们对相关工作进行了描述和总结。


## 2. 基本的FT设计

图1显示了我们的容错系统基本的组织。对于我们希望提供容错能力的虚拟机，我们在不同的物理服务器上运行备用虚拟机，该备用虚拟机与主虚拟机保持同步，并与主虚拟机以相同的方式执行，不过延迟很小。我们说这两个虚拟机是虚拟锁步的。虚拟机的虚拟磁盘位于共享存储（如光钎通道或iSCISI磁盘阵列）上，因此主虚拟机和备份虚拟机可以访问这些虚拟磁盘进行输入和输出。（我们将在4.1节讨论主虚拟机和备用虚拟机不使用共享磁盘存储的设计）仅有主虚拟机暴露它的网络，因此所有的网络输入都进入主虚拟机。类似的，所有其他输入（如键盘和鼠标）只到主虚拟机。

主虚拟机接收的所有输入通过名为 *logging channel* 的网络连接发往备用虚拟机。服务器工作负载主要的来源是网络流量和磁盘I/O。如下文的2.1所讨论，必要时传输的额外信息，以确保备份虚拟机非确定操作与主虚拟机以相同的方式运行。这样备用虚拟机总是与主虚拟机以相同的方式执行。然而，备用虚拟机的输出被管理程序丢弃，因此只有主虚拟机产生输出返回给客户端。如2.2节所述，主虚拟机和备用虚拟机遵循明确的协议，包含备份虚拟机的明确回复，以确保主虚拟机发生故障时不会丢失任何数据。

为了检测主虚拟机或备用虚拟机是否发生故障，我们的系统使用相关服务器心跳和 *logging channel* 上的流量监控两者组合的方式。此外，我们还需要保证有一台主虚拟机或备用虚拟机来接管执行，即使主服务器和备用服务器之间通信丢失发生脑裂的情况。

在后续的部分，我们将提供几个重要领域更多的相关信息。在2.1节中，我们详细介绍了确定性重放技术，该技术通过向*logging channel*发送信息来确保主虚拟机和备用虚拟机之间同步执行。在2.2节中，我们描述了FT协议的基本规则，它确保主服务器失败时没有数据丢失。在2.3节中，我们描述了检测和响应故障的正确的方法。

## 2.1 确定性重放实现

同之前所描述的一样，复制服务器（或ＶＭ）的执行可以建模为确定性状态机的复制。


[原文](/distributed-systems/mit-6.824/lec04-fault-tolerant-virtual-machines-paper.html)